name: Uni PR Builder

on:
  push:
    branches: [ develop, main ]

permissions:
  contents: read

jobs:
  ci:
    uses: ./.github/workflows/gradle-task.yml
    with:
      tasks : '["checkstyleMain", "checkstyleTest", "build -x test", "test"]'
    secrets: inherit

  publish-test-result:
    needs:
      - ci
    runs-on: ubuntu-latest
    steps:
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v1
        with:
          files: build/test-results/**/*.xml

  result-failure:
    needs:
      - ci
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: On Failed, Notify in Slack
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: '#ff0000'
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: 'Uni/Server Debug build Fail❌ 에러를 확인해주세요'
          SLACK_ICON: ${{ github.event.org.avatar_url }}
          MSG_MINIMAL: event,actions url, commit
          SLACK_USERNAME: Uni-server
          SLACK_MESSAGE: '${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.number}}'
